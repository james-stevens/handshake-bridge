#! /bin/bash
# (c) Copyright 2020 - James Stevens

pipecmd="logger -i -t handshake-bridge-cron"
if test "${1}" = "startup"; then pipecmd="cat"; fi


{
base="$(dirname $(dirname ${0}))"
if test "${base}" = "."; then base="$(pwd)"; fi

if test -z "${base}"
	then
		echo "ERROR: Finding directory base"
		exit 1
	fi

. ${base}/config

icann_root="${bind_local_prefix}.3"
if test "${1}" = "startup"; then icann_root="f.root-servers.net."; fi


function handshake_header()
{
	echo ". 86400  IN SOA . . ${1} 1800 900 604800 86400"
	echo ". 518400 IN NS ."
	echo ". 518400 IN A 127.0.0.1"
}


digcmd="dig +nocmd +nocomments +nostats"

rm -f ${base}/tmp/*


icann_old_soa=0
newest_icann=$(ls ${base}/zones/icann* 2>/dev/null | tail -1)
if test "${newest_icann}" -a -f "${newest_icann}"
	then
		icann_old_soa="$(awk '{ if (($1==".")&&($4=="SOA")) { print $7; exit(0) } }' ${newest_icann})"
	fi

icann_now_soa="$(${digcmd} +norec +short @${icann_root} . soa | awk '{ print $3 }')"

resign="N"
if test "${1}" = "force"; then resign="Y"; fi

now="$(date +%Y%m%d_%H%M%S)"


if test ${icann_now_soa} -gt ${icann_old_soa}
	then
		tmp=$(mktemp ${base}/tmp/icann_XXXXXX)
		${digcmd} @${icann_root} . axfr | tr $'\t' ' ' | awk 'BEGIN {
			block["RRSIG"] = "Y"; block["NSEC"] = "Y";
			block["NSEC3"] = "Y"; block["DNSKEY"] = "Y";
			block["NSEC3PARAM"] = "Y"; } 
			{ 
			if (block[$4] != "Y") print 
			}' > ${tmp}

		newest_icann="${base}/zones/icann_${now}.txt"
		mv ${tmp} ${newest_icann}
		resign="Y"
	fi




handshake_old_soa=0
newest_handshake=$(ls ${base}/zones/handshake* 2>/dev/null | tail -1)
if test "${newest_handshake}" -a -f "${newest_handshake}"
	then
		handshake_old_soa="$(awk '{ if (($1==".")&&($4=="SOA")) { print $7; exit(0) } }' ${newest_handshake})"
	fi

handshake_now_soa="$(${digcmd} +norec +short @${hsd_server_addr} . soa | awk '{ print $3 }')"


if test ${handshake_now_soa} -gt ${handshake_old_soa}
	then
		tmp=$(mktemp ${base}/tmp/handshake_XXXXXX)
		handshake_header "${handshake_now_soa}" > "${tmp}~"

		${hsd_rpc} dumpzone ${tmp} > /dev/null 2>&1

		x=0
		while ! test -s ${tmp}
			do
				echo -n "."
				x=$[${x}+1]
				if test ${x} -gt 180
					then
						rm -f tmp/*
						echo ""
						echo "ERROR: RPC dumpzone to ${tmp} Failed"
						exit 1
					fi
				sleep 1
			done

		echo ""
		newest_handshake="${base}/zones/handshake_${now}.txt"
		mv ${tmp} ${newest_handshake}
		resign="Y"
	fi


# echo "----> ${resign} ${newest_handshake} ${newest_icann}"
if ! test "${resign}" = "Y"
	then
		echo "Resigning not required"
		exit 0
	fi


if test "${priority_icann}" = "Y"
	then
		file="${newest_handshake}"
		keep="${newest_icann}"
		dups="Handshake"
	else
		keep="${newest_handshake}"
		file="${newest_icann}"
		dups="ICANN"
	fi



{
handshake_header "$(date +%s)"

grep -v '^. ' ${keep}

awk 'BEGIN {
	keep="'"${keep}"'"
	dups="'"${base}"'/tmp/dups"

	while((getline < keep)==1) in_keep[$1]="Y"
	in_keep["."] = "Y"
	}
	{
		if (in_keep[$1]!="Y") print
		else {
			if ($1 != ".") print $0 > dups
			}
	}' ${file}

} > ${base}/tmp/ROOT


if test -s tmp/dups
	then
		awk '{ print "'"${dups}"' Duplicate removed:",$0 }' tmp/dups
		rm -f tmp/dups
	fi

if ! named-checkzone -i local-sibling -k ignore . tmp/ROOT
	then
		echo "ERROR: Merged ROOT zone failed validation check"
		exit 1
	fi


. ${base}/etc/nsec3.salt

start="$(awk 'BEGIN { x=systime(); srand(x/604800*13); x = int(x / 604800) * 604800; x += int(rand() * 86400); print strftime("%Y%m%d%H%M%S",x); }')"

cd ${base}/tmp
dnssec-signzone -s ${start} -o . -t -R -S -A -H 5 -3 ${nsec3_salt} -K ../keys ROOT
cd ${base}

if ! named-checkzone -i local-sibling -k ignore . tmp/ROOT.signed
	then
		echo "ERROR: Merged & Signed ROOT zone failed validation check"
		exit 1
	else
		cp tmp/ROOT.signed named/zones/
		if ! test "${1}" = "startup"
			then
				rndc -c ${base}/etc/rndc.conf reload . in root
			fi
	fi

rm tmp/*

} 2>&1 | ${pipecmd}
