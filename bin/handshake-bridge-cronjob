#! /bin/bash
# (c) Copyright 2020 - James Stevens

export PATH=/bin:/sbin:/usr/bin:/usr/sbin

pipecmd="logger -t handshake-bridge-cron"
if test "${1}" || tty -s ; then pipecmd="cat"; fi


{
echo "Starting update check"

base="$(dirname $(dirname ${0}))"
if test "${base}" = "."; then base="$(pwd)"; fi

if test -z "${base}"
	then
		echo "ERROR: Finding directory base"
		exit 1
	fi

cd ${base}
. ${base}/config




icann_root="${bind_local_prefix}.3"
if test "${1}" = "startup"; then icann_root="f.root-servers.net."; fi


function handshake_header()
{
	echo ". 3600  IN SOA . . ${1} 1800 900 604800 86400"
	echo ". 518400 IN NS a-root-names-servers-net."
	echo ". 518400 IN NS b-root-names-servers-net."
	echo "a-root-names-servers-net. 86400 in a 127.9.0.5"
	echo "b-root-names-servers-net. 86400 in a 127.9.0.2"
}


digcmd="dig +nocmd +nocomments +nostats"

rm -fv ${base}/tmp/*


icann_old_soa=0
newest_icann=$(ls ${base}/zones/icann* 2>/dev/null | tail -1)
if test "${newest_icann}" -a ! -s "${newest_icann}"
	then
		echo "ERROR: ICANN file is empty"
		rm -vf "${newest_icann}"
		exit 1
	fi
	
if test "${newest_icann}" -a -s "${newest_icann}"
	then
		icann_old_soa="$(awk '{ if (($1==".")&&($4=="SOA")) { print int($7)+0; exit(0) } }' ${newest_icann})"
		if test -z "${icann_old_soa}" -o "${icann_old_soa}" -lt 1
			then
				echo "ERROR: Failed to read old SOA for ICANN"
				rm -fv "${newest_icann}"
				exit 1
			fi
	fi

icann_now_soa="$(${digcmd} +norec +short @${icann_root} . soa | awk '{ print $3 }')"

if test -z "${icann_now_soa}" -o "${icann_now_soa}" -lt 1
	then
		echo "ERROR: Failed to query for ICANN SOA Serial"
		exit 1
	fi

resign="N"
if test "${1}" = "force"; then resign="Y"; fi

now="$(date +%Y%m%d_%H%M%S)"

changed_files="${base}/tmp/none"


if test "${icann_now_soa}" -gt "${icann_old_soa}"
	then
		echo "ICANN SOA Serial has changed - ${icann_old_soa} -> ${icann_now_soa}"

		tmp=$(mktemp ${base}/tmp/icann_XXXXXX)
		${digcmd} @${icann_root} . axfr | awk '{
			x=$0;
			gsub("\t"," ",x);
			while(index(x,"  ")) gsub("  "," ",x);
			print x }' | sort > ${tmp}
		
		if ! test -s ${tmp}
			then
				echo "ERROR: ICANN axfr failed"
				rm -fv ${base}/tmp/*
				exit 1
			fi

		if ! named-checkzone -q -i local-sibling -n ignore -k ignore . ${tmp}
			then
				echo "ERROR: ICANN file failed checks"
				rm -fv ${base}/tmp/*
				exit 1
			fi

		if ! dnssec-verify -o . ${tmp}
			then
				echo "ERROR: ICANN ROOT zone failed DNSSEC verification"
				rm -fv ${base}/tmp/*
				exit 1
			fi

		awk 'BEGIN {
			block["RRSIG"] = "Y"; block["NSEC"] = "Y";
			block["NSEC3"] = "Y"; block["DNSKEY"] = "Y";
			block["NSEC3PARAM"] = "Y";
			}
			{ if (block[$4] != "Y") print }' ${tmp} > ${tmp}.unsiged

		newest_icann="${base}/zones/icann_${now}.txt"
		mv -v ${tmp}.unsiged ${newest_icann}
		changed_files="${changed_files} ${newest_icann}"
		resign="Y"
	fi



handshake_old_soa=0
newest_handshake=$(ls ${base}/zones/handshake* 2>/dev/null | tail -1)
if test "${newest_handshake}" -a ! -s "${newest_handshake}"
	then
		echo "ERROR: Handshake newest file is empty"
		rm -vf "${newest_handshake}" ${changed_files}
		exit 1
	fi
	
if test "${newest_handshake}" -a -s "${newest_handshake}"
	then
		handshake_old_soa="$(awk '{ if (($1==".")&&($4=="SOA")) { print int($7)+0; exit(0) } }' ${newest_handshake})"
		if test -z "${handshake_old_soa}" -o "${handshake_old_soa}" -lt 1
			then
				echo "ERROR: Handshake ${newest_handshake} has not SOA"
				rm -vf "${newest_handshake}" ${changed_files}
				exit 1
			fi
	fi

handshake_now_soa="$(${digcmd} +norec +short @${hsd_server_addr} . soa | awk '{ print $3 }')"

if test -z "${handshake_now_soa}" -o "${handshake_now_soa}" -lt 1
	then
		echo "ERROR: Failed to query for Handshake SOA Serial"
		rm -vf "${newest_handshake}" ${changed_files}
		exit 1
	fi

if test "${handshake_now_soa}" -gt "${handshake_old_soa}"
	then
		echo "Handshake SOA Serial has changed - ${handshake_old_soa} -> ${handshake_now_soa}"
		tmp=$(mktemp ${base}/tmp/handshake_XXXXXX)

		handshake_header "${handshake_now_soa}" > "${tmp}~"

		${hsd_rpc} dumpzone ${tmp} > /dev/null 2>&1

		x=0
		while test -f ${tmp}~ -a ! -s ${tmp}
			do
				echo -n "."
				x=$[${x}+1]
				if test ${x} -gt 300
					then
						echo ""
						echo "ERROR: RPC dumpzone to ${tmp} Timed-out"
						ls -l ${tmp}*
						rm -fv ${base}/tmp/* ${changed_files}
						exit 1
					fi
				sleep 1
			done

		echo ""
		if ! named-checkzone -q -i local-sibling -n ignore -k ignore . ${tmp}
			then
				rm -fv ${changed_files} ${base}/tmp/*
				exit 1
			fi

		newest_handshake="${base}/zones/handshake_${now}.txt"
		mv ${tmp} ${newest_handshake}
		changed_files="${changed_files} ${newest_handshake}"
		resign="Y"
	fi


# echo "----> ${resign} ${newest_handshake} ${newest_icann}"
if ! test "${resign}" = "Y"
	then
		echo "Resigning not required"
		exit 0
	fi


if test "${priority_icann}" = "Y"
	then
		file="${newest_handshake}"
		keep="${newest_icann}"
		dups="Handshake"
	else
		keep="${newest_handshake}"
		file="${newest_icann}"
		dups="ICANN"
	fi



{
handshake_header "$(date +%s)"
echo ". 3600 in txt \"ICANN SOA\" \"${icann_now_soa}\""
echo ". 3600 in txt \"Handshake SOA\" \"${handshake_now_soa}\""

grep -v '^. ' ${keep}

awk 'BEGIN {
	keep="'"${keep}"'"
	dups="'"${base}"'/tmp/dups"

	while((getline < keep)==1) in_keep[$1]="Y"
	in_keep["."] = "Y"
	}
	{
		if (in_keep[$1]!="Y") print
		else {
			if ($1 != ".") print $0 > dups
			}
	}' ${file}

} > ${base}/tmp/ROOT

ls -l ${base}/tmp/ROOT

if test -s ${base}/tmp/dups
	then
		awk '{ print "'"${dups}"' Duplicate removed:",$0 }' ${base}/tmp/dups
		rm -fv ${base}/tmp/dups
	fi


if ! named-checkzone -i local-sibling -k ignore . ${base}/tmp/ROOT >/dev/null 2>&1
	then
		echo "ERROR: Merged ROOT zone failed validation check"
		rm -vf ${changed_files}
		exit 1
	fi

ls -l ${base}/tmp/ROOT

. ${base}/etc/nsec3.salt

start="$(awk 'BEGIN { x=systime(); srand(x/604800*13); x = (int(x / 604800)-1) * 604800; x += int(rand() * 86400); print strftime("%Y%m%d%H%M%S",x); }')"

cd ${base}/tmp
if ! dnssec-signzone -s ${start} -o . -t -P -R -S -A -H 5 -3 ${nsec3_salt} -K ${base}/keys ROOT
	then
		echo "ERROR: dnssec-signzone failed"
		rm -vf ${changed_files}
		exit 1
	fi
mv dsset-. ${base}
cd ${base}


if ! named-checkzone -i local-sibling -k ignore . ${base}/tmp/ROOT.signed
	then
		echo "ERROR: Merged & Signed ROOT zone failed validation check"
		rm -vf ${changed_files}
		exit 1
	else
		cp ${base}/tmp/ROOT.signed ${base}/named/zones/
		if ! test "${1}" = "startup"
			then
				rndc -c ${base}/etc/rndc.conf reload . in root
			fi
	fi

rm ${base}/tmp/*

keep_zones_files=5
cd zones
handshake_files="$(ls -t handshake_* | tail -n +$[${keep_zones_files}+1])"
icann_files="$(ls -t icann_* | tail -n +${keep_zones_files})"

if test "${handshake_files}${icann_files}"
	then
		mv ${handshake_files} ${icann_files} ${base}/archive
		cd ${base}/archive
		xz ${handshake_files} ${icann_files}
	fi
cd ${base}

find ${base}/archive/ -type f -mtime +30 -delete -print | awk '{ print "Removing",$0 }'

echo "Resign Finished"
} 2>&1 | ${pipecmd}
